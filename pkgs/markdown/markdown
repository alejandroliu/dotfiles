#!/usr/bin/php 
<?php
$mode = "std";
if (file_exists("LIBDIR/markdownEx.php")) {
  # If we have markdownEx available we change default modes
  $mode = "extra";
}

$verbose = 0;
$view = 0;

array_shift($argv);	# Skip cmd name

while (count($argv) > 0) {
  if ($argv[0] == "--std") {
    $mode = "std";
  } else if ($argv[0] == "--view") {
    $view = 1;
  } else if ($argv[0] == "-v" || $argv[0] == "--verbose") {
    $verbose=1;
  } else if ($argv[0] == "-q" || $argv[0] == "--quiet") {
    $verbose=0;
  } else if ($argv[0] == "--extra") {
    $mode = "extra";
  } else {
    break;
  }
  array_shift($argv);
}

function fileroot($filepath)
{
  $bname=basename($filepath);
  $pos = strrpos($bname,".");
  if ($pos) {
    $bname = substr($bname,0,$pos);
    # echo "$filepath - $pos $bname\n";
  }
  return dirname($filepath)."/".$bname;
}

if ($mode == "extra") {
  include_once "LIBDIR/markdownEx.php";
} else {
  include_once "LIBDIR/markdown.php";
}

if (count($argv) == 0) {
  $txt = file_get_contents("php://stdin");
  $html = Markdown($txt);
  print $html;
} else {
  if ($verbose) {
    $STDERR = fopen("php://stderr","w");
  }
  foreach ($argv as $file) {
    $txt = file_get_contents($file);
    $html = Markdown($txt);
    $target = fileroot($file).".html";
    if ($verbose) {
      fwrite($STDERR,"Converting $file to ".basename($target)."\n");
    }
    file_put_contents($target,$html);
    if ($view) {
       system("xdg-open $target");
    }
  }
}

?>
