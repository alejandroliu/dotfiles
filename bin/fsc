#!/bin/sh
#
# My tc-play encryption wrapper
#
set -euf -o pipefail
rundir=/run/fsc

die() {
  echo "$@" 1>&2
  exit "$1"
}

[ $# -eq 0 ] && die 3 "Usage: $0 map|unmap"

if [ $UID -ne 0 ] ; then
  echo "Running using sudo..." 1>&2
  exec sudo "$0" "$@"
  exit 1
fi


tc_map() {
  local crfile="$1" crname="$(basename "$1")" lodev=$(losetup -f)

  [ ! -f "$crfile" ] && die 3 "$crfile: not found"
  [ -d "$rundir/$crname" ] && die 4 "$rundir/$crname: directory exists"

  losetup "$lodev" "$crfile"
  tcplay -m "$crname" -d "$lodev"
  mkdir -p "$rundir/$crname"
  mount -o nodev,nosuid "/dev/mapper/$crname" "$rundir/$crname"
}

tc_unmap() {
  local crname="$(basename "$1")"
  [ ! -d "$rundir/$crname" ] && die 6 "$1: Not a tc managed volume"

  local devmapper=$(awk '$2 == "'"$rundir/$crname"'" { print $1 }' /proc/mounts)
  [ -z "$devmapper" ] && die 8 "$1: not a mounted path"

  lodev="$(tcplay -j "$(basename "$devmapper")" | awk '$1 == "Device:" { print $2 }')"

  umount -R "$rundir/$crname"
  rmdir "$rundir/$crname"
  dmsetup remove "$(basename "$devmapper")"
  losetup -d "$lodev"

}

case "$1" in
  map) tc_map /media/mx4/cuser-home/verafile ;;
  unmap) tc_unmap verafile ;;
esac
